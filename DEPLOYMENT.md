# Deployment Guide

This guide walks through the complete deployment process for the Volleyball Community Bot platform.

## Prerequisites

1. **GCP Account** with billing enabled
2. **Tools installed locally:**
   - `gcloud` CLI (authenticated)
   - `terraform` >= 1.5
   - `kubectl`
   - `helm` >= 3.0
   - Docker (for local testing)
3. **GitHub repository** with Actions enabled
4. **Telegram Bot Token** (create via @BotFather)

## Step 1: Configure GCP Project

```bash
# Set your project ID
export PROJECT_ID="your-project-id"
export REGION="us-central1"

# Set the project
gcloud config set project $PROJECT_ID

# Enable required APIs
gcloud services enable \
  container.googleapis.com \
  sqladmin.googleapis.com \
  artifactregistry.googleapis.com \
  secretmanager.googleapis.com \
  aiplatform.googleapis.com \
  compute.googleapis.com \
  servicenetworking.googleapis.com
```

## Step 2: Deploy Infrastructure with Terraform

```bash
cd terraform

# Copy example variables
cp terraform.tfvars.example terraform.tfvars

# Edit terraform.tfvars with your values
nano terraform.tfvars

# Initialize Terraform
terraform init

# Review the plan
terraform plan

# Apply (this will take 10-15 minutes)
terraform apply
```

Save the outputs - you'll need them later:

```bash
terraform output > ../terraform-outputs.txt
```

## Step 3: Configure Secrets

### Create Telegram Bot Token Secret

```bash
# Get your token from @BotFather on Telegram
echo -n "YOUR_TELEGRAM_BOT_TOKEN" | gcloud secrets create telegram-bot-token \
  --data-file=- \
  --replication-policy=automatic

# Verify
gcloud secrets versions access latest --secret=telegram-bot-token
```

### Database Password

The database password was automatically generated by Terraform and stored in Secret Manager.

## Step 4: Run Database Migrations

```bash
# Get Cloud SQL instance connection name
export INSTANCE_CONNECTION_NAME=$(terraform output -raw cloudsql_connection_name)

# Option 1: Using Cloud SQL Proxy
cloud-sql-proxy $INSTANCE_CONNECTION_NAME &
export PGHOST=127.0.0.1
export PGPORT=5432
export PGUSER=volleyball_app
export PGDATABASE=volleyball
export PGPASSWORD=$(gcloud secrets versions access latest --secret=db-password)

psql < ../migrations/init.sql

# Option 2: Direct connection (if you enabled public IP)
gcloud sql connect volleyball-db --user=volleyball_app --database=volleyball < ../migrations/init.sql
```

## Step 5: Configure Helm Values

```bash
cd ../helm/volleyball-bot

# Copy values and update with your configuration
cp values.yaml values-prod.yaml

# Edit values-prod.yaml:
# - Update projectId
# - Update image repositories
# - Update Cloud SQL instance connection name
# - Add TELEGRAM_CHAT_ID
# - Update ingress hostname if needed
nano values-prod.yaml
```

Key values to update:

```yaml
global:
  projectId: "your-project-id"
  region: "us-central1"

botApi:
  image:
    repository: us-central1-docker.pkg.dev/your-project-id/volleyball-images/bot-api

  cloudSqlProxy:
    instanceConnectionName: "your-project-id:us-central1:volleyball-db"

jobs:
  env:
    - name: TELEGRAM_CHAT_ID
      value: "your-telegram-chat-id"  # Get this from your Telegram group
```

## Step 6: Build and Push Initial Images

### Build Bot API

```bash
cd ../../services/bot-api

# Authenticate Docker
gcloud auth configure-docker ${REGION}-docker.pkg.dev

# Build and push
docker build -t ${REGION}-docker.pkg.dev/${PROJECT_ID}/volleyball-images/bot-api:v1.0.0 .
docker push ${REGION}-docker.pkg.dev/${PROJECT_ID}/volleyball-images/bot-api:v1.0.0
docker tag ${REGION}-docker.pkg.dev/${PROJECT_ID}/volleyball-images/bot-api:v1.0.0 \
           ${REGION}-docker.pkg.dev/${PROJECT_ID}/volleyball-images/bot-api:latest
docker push ${REGION}-docker.pkg.dev/${PROJECT_ID}/volleyball-images/bot-api:latest
```

### Build Jobs

```bash
cd ../jobs

# Copy database models
cp -r ../bot-api/db .

# Build and push
docker build -t ${REGION}-docker.pkg.dev/${PROJECT_ID}/volleyball-images/jobs:v1.0.0 .
docker push ${REGION}-docker.pkg.dev/${PROJECT_ID}/volleyball-images/jobs:v1.0.0
docker tag ${REGION}-docker.pkg.dev/${PROJECT_ID}/volleyball-images/jobs:v1.0.0 \
           ${REGION}-docker.pkg.dev/${PROJECT_ID}/volleyball-images/jobs:latest
docker push ${REGION}-docker.pkg.dev/${PROJECT_ID}/volleyball-images/jobs:latest
```

## Step 7: Deploy to GKE with Helm

```bash
# Get cluster credentials
gcloud container clusters get-credentials volleyball-cluster \
  --region=${REGION} \
  --project=${PROJECT_ID}

# Verify connection
kubectl get nodes

# Deploy with Helm
cd ../../helm
helm upgrade --install volleyball-bot ./volleyball-bot \
  -f volleyball-bot/values-prod.yaml \
  --wait \
  --timeout 10m

# Check deployment
kubectl get pods
kubectl get services
kubectl get cronjobs
```

## Step 8: Configure Telegram Webhook

Get your ingress IP or hostname:

```bash
kubectl get ingress
```

Set the webhook URL for your bot:

```bash
export BOT_TOKEN=$(gcloud secrets versions access latest --secret=telegram-bot-token)
export WEBHOOK_URL="https://your-domain.com/webhook"

curl "https://api.telegram.org/bot${BOT_TOKEN}/setWebhook?url=${WEBHOOK_URL}"
```

Verify webhook:

```bash
curl "https://api.telegram.org/bot${BOT_TOKEN}/getWebhookInfo"
```

## Step 9: Set Up GitHub Actions

### Configure Workload Identity Federation

The Terraform setup already created the Workload Identity Pool. Get the values:

```bash
cd ../terraform
terraform output workload_identity_provider
terraform output github_actions_service_account
```

### Add GitHub Secrets

In your GitHub repository, go to Settings > Secrets and variables > Actions, and add:

1. `GCP_PROJECT_ID`: Your GCP project ID
2. `GCP_WORKLOAD_IDENTITY_PROVIDER`: The WIF provider name from Terraform output
3. `GCP_SERVICE_ACCOUNT`: The service account email from Terraform output

### Test CI/CD

Push a change to trigger the workflow:

```bash
git add .
git commit -m "Initial deployment"
git push origin main
```

Monitor the GitHub Actions workflow in the Actions tab.

## Step 10: Verify Everything Works

### Check Bot API

```bash
# Get the service URL
kubectl get service volleyball-bot-bot-api

# Test health endpoint
curl http://<EXTERNAL-IP>/health
```

### Check CronJobs

```bash
# List all cronjobs
kubectl get cronjobs

# Manually trigger a job for testing
kubectl create job --from=cronjob/volleyball-bot-trivia-tuesday test-trivia-job

# Watch job progress
kubectl get jobs -w

# Check logs
kubectl logs -l job-name=test-trivia-job
```

### Test in Telegram

1. Add your bot to a Telegram group
2. Make yourself an admin
3. Send `/start` to verify the bot responds
4. Add/remove members to test join/leave tracking
5. Wait for scheduled jobs or manually trigger them

## Monitoring and Logs

### View Logs

```bash
# Bot API logs
kubectl logs -l app.kubernetes.io/component=bot-api -f

# Job logs (find recent job pods)
kubectl get pods | grep trivia
kubectl logs <pod-name>
```

### Cloud Logging

```bash
# View in Cloud Console
gcloud logging read "resource.type=k8s_container" --limit 50 --format json
```

### Check Database

```bash
# Connect to Cloud SQL
gcloud sql connect volleyball-db --user=volleyball_app

# Run queries
SELECT * FROM polls ORDER BY created_at DESC LIMIT 5;
SELECT * FROM job_runs ORDER BY created_at DESC LIMIT 10;
```

## Troubleshooting

### Pod Issues

```bash
# Describe pod
kubectl describe pod <pod-name>

# Check events
kubectl get events --sort-by='.lastTimestamp'

# Check resource usage
kubectl top pods
```

### Database Connection Issues

```bash
# Verify Cloud SQL Proxy is running
kubectl get pods | grep cloud-sql-proxy

# Check service account permissions
kubectl describe serviceaccount bot-api

# Verify Workload Identity binding
gcloud iam service-accounts get-iam-policy \
  bot-api-sa@${PROJECT_ID}.iam.gserviceaccount.com
```

### Webhook Issues

```bash
# Check webhook status
curl "https://api.telegram.org/bot${BOT_TOKEN}/getWebhookInfo"

# Delete and reset webhook
curl "https://api.telegram.org/bot${BOT_TOKEN}/deleteWebhook"
curl "https://api.telegram.org/bot${BOT_TOKEN}/setWebhook?url=${WEBHOOK_URL}"
```

## Scaling and Performance

### Scale Bot API

```bash
# Manual scaling
kubectl scale deployment volleyball-bot-bot-api --replicas=5

# Or update HPA
kubectl edit hpa volleyball-bot-bot-api
```

### Upgrade Cloud SQL

Edit `terraform/cloudsql.tf` and change the tier:

```hcl
settings {
  tier = "db-custom-4-15360"  # 4 vCPUs, 15GB RAM
}
```

Apply:

```bash
cd terraform
terraform apply
```

## Cleanup

To destroy all resources:

```bash
# Delete Helm release
helm uninstall volleyball-bot

# Destroy Terraform infrastructure
cd terraform
terraform destroy
```

## Next Steps

1. Set up monitoring alerts
2. Configure backup retention policies
3. Add additional API endpoints
4. Implement rate limiting
5. Set up staging environment
6. Configure custom domain with SSL
7. Add more sophisticated trivia generation
8. Implement player statistics dashboard
